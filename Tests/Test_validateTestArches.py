
import unittest
import scanner.logSetup as logSetup
import os.path
import pprint
import pArch

# Unit testing driven by lolcat images
# AS GOD INTENDED!

arches = [
		"allArch.zip",
		"notQuiteAllArch.zip",
		"regular.zip",
		"small.zip",
		"testArch.zip",
		"z_reg_junk.zip",
		"z_reg.zip",
		"z_sml_u.zip",
		"z_sml_w.zip",
		"z_sml.zip",
		"regular-u.zip",
		"small_and_regular_half_common.zip",
		"small_and_regular.zip",
]


expect = {'allArch.zip': [('Lolcat_this_is_mah_job.jpg',
                  {'hexHash': 'd9ceeb6b43c2d7d096532eabfa6cf482',
                   'imX': 493,
                   'imY': 389,
                   'pHash': -4992890192511777340,
                   'type': 'image/jpeg'}),
                 ('Lolcat_this_is_mah_job.png',
                  {'hexHash': '1268e704908cc39299d73d6caafc23a0',
                   'imX': 493,
                   'imY': 389,
                   'pHash': -4992890192511777340,
                   'type': 'image/png'}),
                 ('Lolcat_this_is_mah_job_small.jpg',
                  {'hexHash': '40d39c436e14282dcda06e8aff367307',
                   'imX': 300,
                   'imY': 237,
                   'pHash': -4992890192511777340,
                   'type': 'image/jpeg'}),
                 ('dangerous-to-go-alone.jpg',
                  {'hexHash': 'dcd6097eeac911efed3124374f44085b',
                   'imX': 325,
                   'imY': 307,
                   'pHash': -7813072021139921681,
                   'type': 'image/jpeg'}),
                 ('lolcat-crocs.jpg',
                  {'hexHash': '6d0a977694630ac9d1d33a7f068e10f8',
                   'imX': 500,
                   'imY': 363,
                   'pHash': -7472365462264617431,
                   'type': 'image/jpeg'}),
                 ('lolcat-oregon-trail.jpg',
                  {'hexHash': '7227289a017988b6bdcf61fd4761f6b9',
                   'imX': 501,
                   'imY': 356,
                   'pHash': -3164295607292040329,
                   'type': 'image/jpeg'})],
 'notQuiteAllArch.zip': [('Lolcat_this_is_mah_job.jpg',
                          {'hexHash': 'd9ceeb6b43c2d7d096532eabfa6cf482',
                           'imX': 493,
                           'imY': 389,
                           'pHash': -4992890192511777340,
                           'type': 'image/jpeg'}),
                         ('Lolcat_this_is_mah_job.png',
                          {'hexHash': '1268e704908cc39299d73d6caafc23a0',
                           'imX': 493,
                           'imY': 389,
                           'pHash': -4992890192511777340,
                           'type': 'image/png'}),
                         ('Lolcat_this_is_mah_job_small.jpg',
                          {'hexHash': '40d39c436e14282dcda06e8aff367307',
                           'imX': 300,
                           'imY': 237,
                           'pHash': -4992890192511777340,
                           'type': 'image/jpeg'}),
                         ('lolcat-crocs.jpg',
                          {'hexHash': '6d0a977694630ac9d1d33a7f068e10f8',
                           'imX': 500,
                           'imY': 363,
                           'pHash': -7472365462264617431,
                           'type': 'image/jpeg'}),
                         ('lolcat-oregon-trail.jpg',
                          {'hexHash': '7227289a017988b6bdcf61fd4761f6b9',
                           'imX': 501,
                           'imY': 356,
                           'pHash': -3164295607292040329,
                           'type': 'image/jpeg'})],
 'regular-u.zip': [('e61ec521-155d-4a3a-956d-2544d4367e02.jpg',
                    {'hexHash': '35484890b48148d260b52ebbb7493ffc',
                     'imX': 500,
                     'imY': 375,
                     'pHash': -1214778561678645686,
                     'type': 'image/jpeg'}),
                   ('funny-pictures-cat-looks-like-an-owl.jpg',
                    {'hexHash': 'bd914f72d824d2a18d076f7643017505',
                     'imX': 492,
                     'imY': 442,
                     'pHash': -7960835595440524977,
                     'type': 'image/jpeg'}),
                   ('funny-pictures-cat-will-do-science.jpg',
                    {'hexHash': '5b5620b0cfcb469aef632864707a0445',
                     'imX': 500,
                     'imY': 674,
                     'pHash': -8653036037266837299,
                     'type': 'image/jpeg'}),
                   ('funny-pictures-kitten-rules-a-tower.jpg',
                    {'hexHash': 'a26d63bdbb38621b8f44c563ff496987',
                     'imX': 500,
                     'imY': 375,
                     'pHash': -1016743032983903389,
                     'type': 'image/jpeg'}),
                   ('superheroes-batman-superman-i-would-watch-the-hell-out-of-this.jpg',
                    {'hexHash': '2931dfcefe6af7c5d024eb798ac5e7c6',
                     'imX': 472,
                     'imY': 700,
                     'pHash': -2452239955093831550,
                     'type': 'image/jpeg'})],
 'regular.zip': [('e61ec521-155d-4a3a-956d-2544d4367e02.jpg',
                  {'hexHash': '35484890b48148d260b52ebbb7493ffc',
                   'imX': 500,
                   'imY': 375,
                   'pHash': -1214778561678645686,
                   'type': 'image/jpeg'}),
                 ('funny-pictures-cat-looks-like-an-owl.jpg',
                  {'hexHash': 'bd914f72d824d2a18d076f7643017505',
                   'imX': 492,
                   'imY': 442,
                   'pHash': -7960835595440524977,
                   'type': 'image/jpeg'}),
                 ('funny-pictures-cat-will-do-science.jpg',
                  {'hexHash': '5b5620b0cfcb469aef632864707a0445',
                   'imX': 500,
                   'imY': 674,
                   'pHash': -8653036037266837299,
                   'type': 'image/jpeg'}),
                 ('funny-pictures-kitten-rules-a-tower.jpg',
                  {'hexHash': 'a26d63bdbb38621b8f44c563ff496987',
                   'imX': 500,
                   'imY': 375,
                   'pHash': -1016743032983903389,
                   'type': 'image/jpeg'})],
 'small.zip': [('e61ec521-155d-4a3a-956d-2544d4367e02-ps.png',
                {'hexHash': 'b4c3d02411a34e1222972cc262a40b89',
                 'imX': 375,
                 'imY': 281,
                 'pHash': -1214778561678645686,
                 'type': 'image/png'}),
               ('funny-pictures-cat-looks-like-an-owl-ps.png',
                {'hexHash': '740555f4e730ab2c6c261be7d53a3156',
                 'imX': 369,
                 'imY': 332,
                 'pHash': -7960835595440524977,
                 'type': 'image/png'}),
               ('funny-pictures-cat-will-do-science-ps.png',
                {'hexHash': 'c47ed1cd79c4e7925b8015cb51bbab10',
                 'imX': 375,
                 'imY': 506,
                 'pHash': -8653036037266837299,
                 'type': 'image/png'}),
               ('funny-pictures-kitten-rules-a-tower-ps.png',
                {'hexHash': 'fb64248009dde8605a95b041b772544a',
                 'imX': 375,
                 'imY': 281,
                 'pHash': -1016743032983903389,
                 'type': 'image/png'}),
               ('superheroes-batman-superman-i-would-watch-the-hell-out-of-this.jpg',
                {'hexHash': '083e179ff11ccf90a0d514651c69c2ca',
                 'imX': 200,
                 'imY': 297,
                 'pHash': -2452239955093831550,
                 'type': 'image/jpeg'})],
 'small_and_regular.zip': [('e61ec521-155d-4a3a-956d-2544d4367e02-ps.png',
                            {'hexHash': 'b4c3d02411a34e1222972cc262a40b89',
                             'imX': 375,
                             'imY': 281,
                             'pHash': -1214778561678645686,
                             'type': 'image/png'}),
                           ('e61ec521-155d-4a3a-956d-2544d4367e02.jpg',
                            {'hexHash': '35484890b48148d260b52ebbb7493ffc',
                             'imX': 500,
                             'imY': 375,
                             'pHash': -1214778561678645686,
                             'type': 'image/jpeg'}),
                           ('funny-pictures-cat-looks-like-an-owl-ps.png',
                            {'hexHash': '740555f4e730ab2c6c261be7d53a3156',
                             'imX': 369,
                             'imY': 332,
                             'pHash': -7960835595440524977,
                             'type': 'image/png'}),
                           ('funny-pictures-cat-looks-like-an-owl.jpg',
                            {'hexHash': 'bd914f72d824d2a18d076f7643017505',
                             'imX': 492,
                             'imY': 442,
                             'pHash': -7960835595440524977,
                             'type': 'image/jpeg'}),
                           ('funny-pictures-cat-will-do-science-ps.png',
                            {'hexHash': 'c47ed1cd79c4e7925b8015cb51bbab10',
                             'imX': 375,
                             'imY': 506,
                             'pHash': -8653036037266837299,
                             'type': 'image/png'}),
                           ('funny-pictures-cat-will-do-science.jpg',
                            {'hexHash': '5b5620b0cfcb469aef632864707a0445',
                             'imX': 500,
                             'imY': 674,
                             'pHash': -8653036037266837299,
                             'type': 'image/jpeg'}),
                           ('funny-pictures-kitten-rules-a-tower-ps.png',
                            {'hexHash': 'fb64248009dde8605a95b041b772544a',
                             'imX': 375,
                             'imY': 281,
                             'pHash': -1016743032983903389,
                             'type': 'image/png'}),
                           ('funny-pictures-kitten-rules-a-tower.jpg',
                            {'hexHash': 'a26d63bdbb38621b8f44c563ff496987',
                             'imX': 500,
                             'imY': 375,
                             'pHash': -1016743032983903389,
                             'type': 'image/jpeg'})],
 'small_and_regular_half_common.zip': [('718933691_2b0100d6d4_o.png',
                                        {'hexHash': '8952f5ece2f5867c3ff2b6e8a55db21f',
                                         'imX': 507,
                                         'imY': 679,
                                         'pHash': -8197763240258625978,
                                         'type': 'image/png'}),
                                       ('CatT.png',
                                        {'hexHash': '5f0aba1e6d1a7cf66c722f0fddb7ed18',
                                         'imX': 125,
                                         'imY': 201,
                                         'pHash': -6104997819240060432,
                                         'type': 'image/png'}),
                                       ('circuit_diagram.png',
                                        {'hexHash': '494b166f7729f18906fae08d6bb93022',
                                         'imX': 740,
                                         'imY': 952,
                                         'pHash': -1241034801844984807,
                                         'type': 'image/png'}),
                                       ('e61ec521-155d-4a3a-956d-2544d4367e02-ps.png',
                                        {'hexHash': 'b4c3d02411a34e1222972cc262a40b89',
                                         'imX': 375,
                                         'imY': 281,
                                         'pHash': -1214778561678645686,
                                         'type': 'image/png'}),
                                       ('e61ec521-155d-4a3a-956d-2544d4367e02.jpg',
                                        {'hexHash': '35484890b48148d260b52ebbb7493ffc',
                                         'imX': 500,
                                         'imY': 375,
                                         'pHash': -1214778561678645686,
                                         'type': 'image/jpeg'}),
                                       ('funny-pictures-cat-looks-like-an-owl-ps.png',
                                        {'hexHash': '740555f4e730ab2c6c261be7d53a3156',
                                         'imX': 369,
                                         'imY': 332,
                                         'pHash': -7960835595440524977,
                                         'type': 'image/png'}),
                                       ('funny-pictures-cat-looks-like-an-owl.jpg',
                                        {'hexHash': 'bd914f72d824d2a18d076f7643017505',
                                         'imX': 492,
                                         'imY': 442,
                                         'pHash': -7960835595440524977,
                                         'type': 'image/jpeg'})],
 'testArch.zip': [('Lolcat_this_is_mah_job.png',
                   {'hexHash': '1268e704908cc39299d73d6caafc23a0',
                    'imX': 493,
                    'imY': 389,
                    'pHash': -4992890192511777340,
                    'type': 'image/png'}),
                  ('Lolcat_this_is_mah_job_small.jpg',
                   {'hexHash': '40d39c436e14282dcda06e8aff367307',
                    'imX': 300,
                    'imY': 237,
                    'pHash': -4992890192511777340,
                    'type': 'image/jpeg'}),
                  ('dangerous-to-go-alone.jpg',
                   {'hexHash': 'dcd6097eeac911efed3124374f44085b',
                    'imX': 325,
                    'imY': 307,
                    'pHash': -7813072021139921681,
                    'type': 'image/jpeg'})],
 'z_reg.zip': [('129165237051396578.jpg',
                {'hexHash': 'b688e3ead00ca1453f860b408c446ec2',
                 'imX': 332,
                 'imY': 497,
                 'pHash': -3913567795023694905,
                 'type': 'image/jpeg'}),
               ('test.txt',
                {'hexHash': 'b3a79c95a10b4cc0a838b35782b4dc0a',
                 'imX': None,
                 'imY': None,
                 'pHash': None,
                 'type': 'text/plain'})],
 'z_reg_junk.zip': [('129165237051396578.jpg',
                     {'hexHash': 'b688e3ead00ca1453f860b408c446ec2',
                      'imX': 332,
                      'imY': 497,
                      'pHash': -3913567795023694905,
                      'type': 'image/jpeg'}),
                    ('Thumbs.db',
                     {'hexHash': '2ea0b76437adb1dfb8889beab9d7ef3b',
                      'imX': None,
                      'imY': None,
                      'pHash': None,
                      'type': 'application/CDFV2'}),
                    ('__MACOSX/test.txt',
                     {'hexHash': '1ad84adee17e7d3525528ff7e381a900',
                      'imX': None,
                      'imY': None,
                      'pHash': None,
                      'type': 'text/plain'}),
                    ('deleted.txt',
                     {'hexHash': '2fe06876bc7694a6357e5d9c5f05e0ab',
                      'imX': None,
                      'imY': None,
                      'pHash': None,
                      'type': 'text/plain'}),
                    ('test.txt',
                     {'hexHash': 'b3a79c95a10b4cc0a838b35782b4dc0a',
                      'imX': None,
                      'imY': None,
                      'pHash': None,
                      'type': 'text/plain'})],
 'z_sml.zip': [('129165237051396578(s).jpg',
                {'hexHash': '7c257ec7fdfd24f249d290dc47dcc71c',
                 'imX': 249,
                 'imY': 373,
                 'pHash': -3913567795023694905,
                 'type': 'image/jpeg'}),
               ('test.txt',
                {'hexHash': 'b3a79c95a10b4cc0a838b35782b4dc0a',
                 'imX': None,
                 'imY': None,
                 'pHash': None,
                 'type': 'text/plain'})],
 'z_sml_u.zip': [('129165237051396578(s).jpg',
                  {'hexHash': '7c257ec7fdfd24f249d290dc47dcc71c',
                   'imX': 249,
                   'imY': 373,
                   'pHash': -3913567795023694905,
                   'type': 'image/jpeg'}),
                 ('test.txt',
                  {'hexHash': '1234ae2e7a21c94100cb60773efe482b',
                   'imX': None,
                   'imY': None,
                   'pHash': None,
                   'type': 'text/plain'})],
 'z_sml_w.zip': [('129165237051396578(s).jpg',
                  {'hexHash': 'e8566233d43b2e964b77471a99c5fa36',
                   'imX': 100,
                   'imY': 100,
                   'pHash': -9223372036854775808,
                   'type': 'image/jpeg'}),
                 ('test.txt',
                  {'hexHash': 'b3a79c95a10b4cc0a838b35782b4dc0a',
                   'imX': None,
                   'imY': None,
                   'pHash': None,
                   'type': 'text/plain'})]
}


class TestSequenceFunctions(unittest.TestCase):

	def __init__(self, *args, **kwargs):
		logSetup.initLogging()

		super().__init__(*args, **kwargs)
		self.maxDiff = None


	def test_validate_arches(self):

		got = {}
		for arch_name in arches:
			cwd = os.path.dirname(os.path.realpath(__file__))
			archPath = os.path.join(cwd, 'test_ptree_base', arch_name)

			arch = pArch.PhashArchive(archPath)

			archHashes = list(arch.iterHashes())
			for item in archHashes:
				del item[1]['cont']
			got[arch_name] = archHashes

		expect_keys = list(expect.keys())
		got_keys    = list(got.keys())

		expect_keys.sort()
		got_keys.sort()

		self.assertEqual(expect_keys, got_keys)

		print()
		print()
		pprint.pprint(expect)
		print()
		print()
		for key in expect_keys:
			if got[key] != expect_keys:
				print("Key:", key)
				pprint.pprint(expect[key])
		for key in expect_keys:
			self.assertEqual(expect[key], got[key])


